<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Site Inspection Manager</title>
    <meta name="description" content="{{.Description}}">
    <meta name="theme-color" content="#2563eb">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SiteInspect">
    <link rel="apple-touch-icon" href="/static/images/icon-192.png">
    
    <!-- Microsoft PWA Support -->
    <meta name="msapplication-TileColor" content="#2563eb">
    <meta name="msapplication-TileImage" content="/static/images/icon-192.png">
    
    <!-- Base Styles -->
    <link rel="stylesheet" href="/static/css/base.css">
    {{range .StyleSheets}}
    <link rel="stylesheet" href="{{.}}">
    {{end}}
    
    <!-- Preload critical resources -->
    {{range .PreloadScripts}}
    <link rel="preload" href="{{.}}" as="script">
    {{end}}
</head>
<body class="{{.BodyClass}}">
    {{template "content" .}}
    
    <!-- Load all scripts in proper dependency order with defer for sequential loading -->
    {{range .Scripts}}
    <script src="{{.}}" defer></script>
    {{end}}
    
    <!-- Service Worker Registration -->
    {{if .EnableSW}}
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                        
                        // Check for updates every 5 minutes
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (window.app && window.app.showNotification) {
                                        window.app.showNotification(
                                            'App updated! Refresh to use the latest version.', 
                                            'info',
                                            10000
                                        );
                                    }
                                }
                            });
                        });
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
                
                // Get current version from service worker
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'GET_VERSION' });
                } else {
                    navigator.serviceWorker.ready.then(() => {
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({ type: 'GET_VERSION' });
                        }
                    });
                }
                
                // Listen for service worker messages
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data.type === 'SW_UPDATED') {
                        console.log('Service Worker updated to version:', event.data.version);
                        
                        const versionElement = document.getElementById('app-version');
                        if (versionElement) {
                            versionElement.textContent = `v${event.data.version}`;
                        }
                        
                        if (window.app && window.app.showNotification) {
                            window.app.showNotification(
                                `App updated to v${event.data.version}! Latest features available.`, 
                                'success'
                            );
                        }
                    } else if (event.data.type === 'VERSION_RESPONSE') {
                        console.log('Current Service Worker version:', event.data.version);
                        
                        const versionElement = document.getElementById('app-version');
                        if (versionElement) {
                            versionElement.textContent = `v${event.data.version}`;
                        }
                    }
                });
            });
        }
    </script>
    {{end}}
</body>
</html>